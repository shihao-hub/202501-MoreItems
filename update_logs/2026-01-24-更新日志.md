# 版本 6.0.4 - 更新日志

**更新时间：** 2026-01-24
**备注：** 本次更新主要完善了跨服数据同步系统，并新增了强san素食堡功能

---

## 🎉 新增功能

### 强san素食堡

- 参考暖胃汉堡包实现，新增永久增加理智值上限的食物
- 使用相同的配方（5个腐烂食物）和视觉效果
- 支持跨服务器同步（主服务器/洞穴）
- 限制在特定角色列表中使用

### 暖胃汉堡包换人继承

- 新增换人继承饥饿度功能
- 可通过配置选项 `stomach_warming_hamburger__inherit_when_change_character` 开启/关闭
- 使用独立的持久化文件系统（按玩家ID存储）
- 换人后自动继承之前保存的饥饿度数据

---

## 🔧 重要修复

### 跨服数据同步系统

- 实现了完整的跨服务器数据同步机制（洞穴 ↔ 地面）
- 修复了洞穴中吃食物后数据不同步到地面的问题
- 修复了跨服后数据丢失的持久化问题
- 优化了数据流：洞穴吃食物 → RPC 同步 → 主服务器存储

### 数据存储优化

- 统一在主服务器存储数据，避免上下洞分离
- 修复了洞穴服务器因文件名为 nil 导致的崩溃
- RPC 接收时直接更新玩家文件，确保数据实时同步
- 添加了文件写入验证机制

### Bug 修复

- 修复了未吃汉堡/强心素食堡也会继承的 bug
- 修复了继承逻辑中未使用世界组件最新数据的问题
- 修复了 Shard RPC 参数传递错误
- 修复了格罗姆奶昔不能对格罗姆使用的 bug

---

## 🛠️ 技术改进

- 新增 `mone_shard_sync` 世界组件，统一管理跨服数据
- 新增 `scripts/moreitems/lib/shard/sync_rpc.lua` RPC 调用辅助库
- 优化了组件文件结构，符合 DST 组件系统规范
- 添加了详细的调试日志用于问题诊断
- 移除了装备柜的换装功能，避免点击冲突

---

**模组反馈 QQ 群：** 592159151
